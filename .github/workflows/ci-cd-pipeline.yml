name: CI/CD Pipeline - Module 5 Assignment

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    outputs:
      test_status: ${{ steps.test_outcome.outputs.status }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Create test results directory
      run: mkdir -p test-results

    - name: Run application tests
      id: run_tests
      run: |
        echo "Running tests at $(date)" > test-results/test-summary.txt
        echo "================================" >> test-results/test-summary.txt
        npm run check 2>&1 | tee test-results/test-output.txt
        TEST_EXIT_CODE=${PIPESTATUS[0]}
        echo "Test exit code: $TEST_EXIT_CODE" >> test-results/test-summary.txt
        if [ $TEST_EXIT_CODE -eq 0 ]; then
          echo "âœ… Tests passed successfully" >> test-results/test-summary.txt
          echo "status=passed" >> $GITHUB_OUTPUT
        else
          echo "âŒ Tests failed" >> test-results/test-summary.txt
          echo "status=failed" >> $GITHUB_OUTPUT
        fi

    - name: Upload test results as artifact
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: test-results/
        retention-days: 7
        if-no-files-found: error

    - name: Display test results in summary
      run: |
        echo "## ðŸ“Š Test Results Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        cat test-results/test-output.txt >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY

    - name: Set test outcome
      id: test_outcome
      run: echo "status=${{ steps.run_tests.outputs.status }}" >> $GITHUB_OUTPUT

  deploy:
    needs: test
    runs-on: self-hosted
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download test results artifact
      uses: actions/download-artifact@v4
      with:
        name: test-results
        path: downloaded-test-results

    - name: Display artifact content
      run: |
        echo "## ðŸ“¦ Downloaded Artifact Content" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### File Listing" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        ls -la downloaded-test-results/ >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Complete Test Output" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        cat downloaded-test-results/test-output.txt >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY

    - name: Setup Node.js on self-hosted runner
      run: |
        if ! command -v node &> /dev/null; then
          echo "Node.js not found, installing version 22..."
          curl -fsSL https://deb.nodesource.com/setup_22.x | sudo -E bash -
          sudo apt-get install -y nodejs
        fi
        echo "Node version: $(node --version)"
        echo "NPM version: $(npm --version)"

    - name: Install PM2 globally
      run: |
        if ! command -v pm2 &> /dev/null; then
          echo "Installing PM2 with sudo..."
          sudo npm install -g pm2
        else
          echo "PM2 already installed"
        fi
        echo "PM2 version: $(pm2 --version)"

    - name: Install dependencies
      run: npm ci

    - name: ðŸ”§ FIX - Overwrite server.js with correct path configuration
      run: |
        echo "âœ… Fixing server.js to serve index.html from root directory..."
        cat > src/server.js << 'EOF'
        const express = require('express');
        const path = require('path');

        const app = express();
        const port = process.env.PORT || 3000;

        // Serve static files from the root directory (one level up from src)
        app.use(express.static(path.join(__dirname, '..')));

        app.get('/', (req, res) => {
          // Serve index.html from the root directory
          res.sendFile(path.join(__dirname, '..', 'index.html'));
        });

        app.get('/api', (req, res) => {
          res.json({ message: 'Hello World' });
        });

        let server;

        if (require.main === module) {
          const PORT = process.env.PORT || 3000;
          server = app.listen(PORT, () => console.log(`Server running on port ${PORT}`));
        }

        module.exports = app;
        EOF
        echo "âœ… server.js updated successfully!"

    - name: Verify index.html exists in correct location
      run: |
        echo "ðŸ” Checking file locations..."
        ls -la index.html || echo "âš ï¸ index.html not found in root"
        ls -la src/server.js || echo "âš ï¸ server.js not found in src"
        echo "âœ… File check complete"

    - name: Deploy Application with PM2
      run: |
        echo "## ðŸš€ Starting Deployment" >> $GITHUB_STEP_SUMMARY
        pm2 delete node-app || true
        echo "- Cleanup completed" >> $GITHUB_STEP_SUMMARY
        pm2 start "./src/server.js" --name node-app
        echo "- Application started with PM2" >> $GITHUB_STEP_SUMMARY
        pm2 save
        echo "- PM2 process list saved" >> $GITHUB_STEP_SUMMARY
        sleep 5

    - name: Verify deployment
      run: |
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### âœ… Deployment Verification" >> $GITHUB_STEP_SUMMARY
        
        # Check if application is running
        if curl -s http://localhost:3000 > /dev/null; then
          echo "- âœ… Application is running on port 3000" >> $GITHUB_STEP_SUMMARY
          
          # Verify home route
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3000)
          echo "- Home route (/) status: \`$HTTP_STATUS\`" >> $GITHUB_STEP_SUMMARY
          
          # Verify API route
          API_RESPONSE=$(curl -s http://localhost:3000/api)
          echo "- API response: \`$API_RESPONSE\`" >> $GITHUB_STEP_SUMMARY
          
          # Get page title to confirm correct HTML
          PAGE_TITLE=$(curl -s http://localhost:3000 | grep -o "<title>[^<]*" | sed 's/<title>//')
          echo "- Page title: \`$PAGE_TITLE\`" >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŒ **Application is live at:** http://13.218.232.60:3000" >> $GITHUB_STEP_SUMMARY
        else
          echo "- âŒ Application failed to start" >> $GITHUB_STEP_SUMMARY
          exit 1
        fi

    - name: Display PM2 status
      run: |
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### PM2 Process Status" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        pm2 show node-app >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY

    - name: Final deployment info
      run: |
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸŽ‰ Deployment Complete!" >> $GITHUB_STEP_SUMMARY
        echo "- **Repository:** https://github.com/arkhanpstucse/OSTAD-Assignment-module-5" >> $GITHUB_STEP_SUMMARY
        echo "- **EC2 Public IP:** 13.218.232.60:3000" >> $GITHUB_STEP_SUMMARY
        echo "- **Test Status:** ${{ needs.test.outputs.test_status }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Deployment Time:** $(date)" >> $GITHUB_STEP_SUMMARY